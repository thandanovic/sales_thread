<% content_for :title, "#{@user.email} - User Management - SLX.ba" %>

<div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
  <div>
    <nav class="flex mb-2" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 text-sm">
        <li><%= link_to "Users", admin_users_path, class: "text-bodydark2 hover:text-primary" %></li>
        <li><span class="text-bodydark2 mx-2">/</span></li>
        <li class="text-bodydark1"><%= @user.email %></li>
      </ol>
    </nav>
    <h2 class="text-title-md2 font-bold text-black dark:text-white"><%= @user.email %></h2>
  </div>
  <div class="flex gap-2">
    <% unless @user == true_user %>
      <%= button_to impersonate_admin_user_path(@user), method: :post, class: "inline-flex items-center justify-center gap-2 rounded-md bg-success px-4 py-2 font-medium text-white hover:bg-success/90 transition-colors" do %>
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        Impersonate
      <% end %>
    <% end %>
    <%= link_to edit_admin_user_path(@user), class: "inline-flex items-center justify-center gap-2 rounded-md bg-primary px-4 py-2 font-medium text-white hover:bg-primary-dark transition-colors" do %>
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
      Edit
    <% end %>
  </div>
</div>

<div class="grid grid-cols-1 gap-6 md:grid-cols-2">
  <%# User Info %>
  <div class="rounded-xl border border-stroke bg-white p-6 shadow-default dark:border-strokedark dark:bg-boxdark">
    <h3 class="text-lg font-semibold text-black dark:text-white mb-4">User Information</h3>
    <dl class="space-y-3">
      <div class="flex justify-between">
        <dt class="text-bodydark2">Email</dt>
        <dd class="font-medium text-black dark:text-white"><%= @user.email %></dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-bodydark2">ID</dt>
        <dd class="font-mono text-sm text-black dark:text-white"><%= @user.id %></dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-bodydark2">System Admin</dt>
        <dd>
          <% if @user.system_admin? %>
            <span class="inline-flex rounded-full bg-danger/10 py-1 px-3 text-sm font-medium text-danger">Yes</span>
          <% else %>
            <span class="inline-flex rounded-full bg-bodydark2/10 py-1 px-3 text-sm font-medium text-bodydark2">No</span>
          <% end %>
        </dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-bodydark2">Created</dt>
        <dd class="text-black dark:text-white"><%= @user.created_at.strftime("%B %d, %Y at %H:%M") %></dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-bodydark2">Last Sign In</dt>
        <dd class="text-black dark:text-white">
          <%= @user.last_sign_in_at ? @user.last_sign_in_at.strftime("%B %d, %Y at %H:%M") : "Never" %>
        </dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-bodydark2">Sign In Count</dt>
        <dd class="text-black dark:text-white"><%= @user.sign_in_count %></dd>
      </div>
    </dl>
  </div>

  <%# Shop Memberships %>
  <div class="rounded-xl border border-stroke bg-white p-6 shadow-default dark:border-strokedark dark:bg-boxdark">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-black dark:text-white">Shop Memberships</h3>
      <button type="button" onclick="document.getElementById('add-membership-form').classList.toggle('hidden')" class="text-sm text-primary hover:text-primary-dark">
        + Add Membership
      </button>
    </div>

    <%# Add membership form (hidden by default) %>
    <div id="add-membership-form" class="hidden mb-4 p-4 rounded-lg border border-stroke dark:border-strokedark bg-white dark:bg-boxdark">
      <%= form_with url: add_membership_admin_user_path(@user), method: :post, class: "space-y-3" do |f| %>
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label class="mb-1 block text-sm font-medium text-black dark:text-white">Shop</label>
            <div class="relative">
              <%= select_tag :shop_id,
                  options_from_collection_for_select(@available_shops, :id, :name),
                  include_blank: "-- Select a shop --",
                  class: "w-full rounded-lg border border-stroke bg-white py-2 pl-3 pr-8 text-sm text-black outline-none focus:border-primary dark:border-strokedark dark:bg-meta-4 dark:text-white appearance-none cursor-pointer" %>
              <span class="absolute top-1/2 right-3 -translate-y-1/2 pointer-events-none">
                <svg class="fill-current text-bodydark2" width="10" height="6" viewBox="0 0 12 8"><path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" fill="none"/></svg>
              </span>
            </div>
          </div>
          <div>
            <label class="mb-1 block text-sm font-medium text-black dark:text-white">Role</label>
            <div class="relative">
              <%= select_tag :role,
                  options_for_select([["Manager", "manager"], ["Agent", "agent"]]),
                  class: "w-full rounded-lg border border-stroke bg-white py-2 pl-3 pr-8 text-sm text-black outline-none focus:border-primary dark:border-strokedark dark:bg-meta-4 dark:text-white appearance-none cursor-pointer" %>
              <span class="absolute top-1/2 right-3 -translate-y-1/2 pointer-events-none">
                <svg class="fill-current text-bodydark2" width="10" height="6" viewBox="0 0 12 8"><path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" fill="none"/></svg>
              </span>
            </div>
          </div>
        </div>
        <div class="flex gap-2">
          <%= submit_tag "Add", class: "inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary-dark transition-colors cursor-pointer" %>
          <button type="button" onclick="document.getElementById('add-membership-form').classList.add('hidden')" class="inline-flex items-center justify-center rounded-md border border-stroke px-4 py-2 text-sm font-medium text-black hover:bg-gray-1 transition-colors dark:border-strokedark dark:text-white dark:hover:bg-meta-4">
            Cancel
          </button>
        </div>
      <% end %>
    </div>

    <% if @memberships.any? %>
      <div class="space-y-3">
        <% @memberships.each do |membership| %>
          <div class="flex items-center justify-between p-3 rounded-lg bg-gray-1 dark:bg-meta-4">
            <div>
              <p class="font-medium text-black dark:text-white"><%= membership.shop.name %></p>
              <p class="text-xs text-bodydark2">Member since <%= membership.created_at.strftime("%b %d, %Y") %></p>
            </div>
            <div class="flex items-center gap-2">
              <%= form_with url: update_membership_admin_user_path(@user, membership_id: membership.id), method: :patch, class: "inline-flex" do %>
                <div class="relative">
                  <%= select_tag :role,
                      options_for_select([["Manager", "manager"], ["Agent", "agent"]], membership.role),
                      onchange: "this.form.submit()",
                      class: "rounded-lg border border-stroke bg-white py-1 pl-2 pr-7 text-sm text-black outline-none focus:border-primary dark:border-strokedark dark:bg-boxdark dark:text-white appearance-none cursor-pointer" %>
                  <span class="absolute top-1/2 right-2 -translate-y-1/2 pointer-events-none">
                    <svg class="fill-current text-bodydark2" width="8" height="5" viewBox="0 0 12 8"><path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                  </span>
                </div>
              <% end %>
              <%= button_to remove_membership_admin_user_path(@user, membership_id: membership.id),
                  method: :delete,
                  data: { turbo_confirm: "Remove #{@user.email} from #{membership.shop.name}?" },
                  class: "text-danger hover:text-danger/80 p-1" do %>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-bodydark2">No shop memberships</p>
    <% end %>
  </div>
</div>
