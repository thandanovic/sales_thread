<div class="mb-8 flex justify-between items-center">
  <div>
    <h1 class="text-3xl font-bold text-gray-900">Products - <%= @shop.name %></h1>
    <p class="mt-2 text-sm text-gray-700">Manage your shop products</p>
  </div>
  <div class="flex space-x-3">
    <%= link_to "Back to Shop", shop_path(@shop), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
    <%= link_to "New Import", new_shop_import_path(@shop), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
    <%= link_to "New Product", new_shop_product_path(@shop), class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700" %>
  </div>
</div>

<% if @products.any? %>
  <%# Actions Container - All bulk operations grouped together %>
  <div class="mb-6 bg-white shadow rounded-lg overflow-hidden border border-gray-200">
    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
      <h3 class="text-sm font-semibold text-gray-900">Actions</h3>
    </div>

    <div class="p-4 space-y-4">

      <%# Bulk Margin Update %>
      <%= form_with url: bulk_update_margin_shop_products_path(@shop), method: :post, id: "bulk-margin-form" do |f| %>
        <div class="bg-blue-50 border-l-4 border-blue-400 rounded-r-lg p-3">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-3">
              <svg class="h-5 w-5 text-blue-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-sm font-medium text-gray-900">Update Margin</span>
            </div>
            <div class="flex items-center gap-2">
              <%= f.number_field :margin, step: 0.01, placeholder: "15.50", class: "block w-20 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm bg-white" %>
              <span class="text-xs font-medium text-gray-700">%</span>
              <%= f.submit "Update Selected", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500", style: "background-color: #2563eb !important; color: white !important;" %>
            </div>
          </div>
        </div>
      <% end %>

      <%# OLX Operations %>
      <div class="bg-green-50 border-l-4 border-green-400 rounded-r-lg p-3">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="flex items-center gap-3">
            <svg class="h-5 w-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <span class="text-sm font-medium text-gray-900">OLX Operations</span>
          </div>
          <div class="flex items-center flex-wrap space-x-2">
            <form action="<%= bulk_publish_to_olx_shop_products_path(@shop) %>" method="post" id="bulk-publish-form">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <button type="submit" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Publish
              </button>
            </form>

            <form action="<%= bulk_update_on_olx_shop_products_path(@shop) %>" method="post" id="bulk-update-form">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <button type="submit" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Update
              </button>
            </form>

            <form action="<%= bulk_remove_from_olx_shop_products_path(@shop) %>" method="post" id="bulk-remove-form" data-turbo-confirm="Are you sure? This will remove the selected products from OLX (but keep them in your database).">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <%= hidden_field_tag :_method, :delete %>
              <button type="submit" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Remove
              </button>
            </form>
          </div>
        </div>
      </div>

      <%# Bulk Delete %>
      <%= form_with url: bulk_destroy_shop_products_path(@shop), method: :delete, id: "bulk-delete-form", data: { turbo_confirm: "Are you sure? This will permanently delete the selected products and all associated data (images, OLX listings, import records). This action cannot be undone." } do |f| %>
        <div class="bg-red-50 border-l-4 border-red-400 rounded-r-lg p-3">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-3">
              <svg class="h-5 w-5 text-red-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span class="text-sm font-medium text-red-900">Delete Products</span>
            </div>
            <%= f.submit "Delete Selected", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# Filters Section %>
  <div class="mb-6 bg-white shadow rounded-lg overflow-hidden border border-gray-200">
    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
      <h3 class="text-sm font-semibold text-gray-900">Filters</h3>
    </div>
    <div class="p-4">
      <%= form_with url: shop_products_path(@shop), method: :get, class: "flex flex-wrap items-end gap-4" do |f| %>
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 mb-2">OLX Status</label>
          <%= f.select :olx_status,
              options_for_select([
                ['All', ''],
                ['Live', 'live'],
                ['Draft', 'draft'],
                ['Not on OLX', 'not_on_olx']
              ], params[:olx_status]),
              {},
              class: "block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>

        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 mb-2">Template</label>
          <%= f.select :template_id,
              options_for_select([['All Templates', '']] + @templates.map { |t| [t.display_name, t.id] }, params[:template_id]),
              {},
              class: "block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>

        <div class="flex gap-2">
          <%= f.submit "Apply Filters", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm" %>
          <%= link_to "Clear", shop_products_path(@shop), class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 shadow-sm" %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Products Table %>
  <div class="bg-white shadow overflow-x-auto rounded-lg">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="w-12 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OLX</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Price</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @products.each do |product| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <input type="checkbox" name="product_ids[]" value="<%= product.id %>" class="product-checkbox h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if product.published_on_olx? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Live</span>
              <% elsif product.has_olx_listing? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Draft</span>
              <% else %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Not on OLX</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if product.images.attached? %>
                <%= image_tag product.images.first, class: "h-12 w-12 rounded object-cover" %>
              <% else %>
                <div class="h-12 w-12 bg-gray-200 rounded flex items-center justify-center">
                  <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
              <% end %>
            </td>
            <td class="px-6 py-4">
              <%= link_to product.title, shop_product_path(@shop, product), class: "text-sm font-medium text-indigo-600 hover:text-indigo-900" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= product.sku %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= number_to_currency(product.price || 0, unit: product.currency || "BAM") %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= number_to_currency(product.final_price || 0, unit: product.currency || "BAM") %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center space-x-2">
                <%= link_to "Edit", edit_shop_product_path(@shop, product), class: "text-indigo-600 hover:text-indigo-900 text-sm font-medium" %>
                <span class="text-gray-300">|</span>
                <%= form_with model: [product.shop, product], method: :patch, local: true, class: "inline-flex items-center gap-1" do |f| %>
                  <%= f.number_field :margin, value: product.margin, step: 0.01, placeholder: "%", class: "block w-12 rounded-md border-gray-300 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-xs py-1" %>
                  <%= f.submit "âœ“", class: "inline-flex items-center px-2 py-1 text-xs font-medium rounded text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm" %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <%# Pagination %>
  <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-4 rounded-lg shadow">
    <%= paginate @products %>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      const productCheckboxes = document.querySelectorAll('.product-checkbox');
      const bulkMarginForm = document.getElementById('bulk-margin-form');
      const bulkDeleteForm = document.getElementById('bulk-delete-form');
      const bulkPublishForm = document.getElementById('bulk-publish-form');
      const bulkUpdateForm = document.getElementById('bulk-update-form');
      const bulkRemoveForm = document.getElementById('bulk-remove-form');

      // Sync checkboxes with select all checkbox
      selectAllCheckbox.addEventListener('change', function() {
        productCheckboxes.forEach(cb => cb.checked = this.checked);
      });

      // Update select all checkbox when individual checkboxes change
      productCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
          const allChecked = Array.from(productCheckboxes).every(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
        });
      });

      // Copy checked product IDs to margin form on submit
      bulkMarginForm.addEventListener('submit', function(e) {
        // Remove any existing product_ids inputs from this form
        const existingInputs = bulkMarginForm.querySelectorAll('input[name="product_ids[]"]');
        existingInputs.forEach(input => input.remove());

        // Add new inputs for checked products
        productCheckboxes.forEach(cb => {
          if (cb.checked) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'product_ids[]';
            input.value = cb.value;
            bulkMarginForm.appendChild(input);
          }
        });
      });

      // Copy checked product IDs to delete form on submit
      bulkDeleteForm.addEventListener('submit', function(e) {
        // Remove any existing product_ids inputs from this form
        const existingInputs = bulkDeleteForm.querySelectorAll('input[name="product_ids[]"]');
        existingInputs.forEach(input => input.remove());

        // Add new inputs for checked products
        let hasChecked = false;
        productCheckboxes.forEach(cb => {
          if (cb.checked) {
            hasChecked = true;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'product_ids[]';
            input.value = cb.value;
            bulkDeleteForm.appendChild(input);
          }
        });

        // Prevent submission if no products selected
        if (!hasChecked) {
          e.preventDefault();
          alert('Please select at least one product to delete.');
          return false;
        }
      });

      // Helper function to copy product IDs to a form
      function copyProductIdsToForm(form, e) {
        // Remove any existing product_ids inputs
        const existingInputs = form.querySelectorAll('input[name="product_ids[]"]');
        existingInputs.forEach(input => input.remove());

        // Add new inputs for checked products
        let hasChecked = false;
        productCheckboxes.forEach(cb => {
          if (cb.checked) {
            hasChecked = true;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'product_ids[]';
            input.value = cb.value;
            form.appendChild(input);
          }
        });

        // Prevent submission if no products selected
        if (!hasChecked) {
          e.preventDefault();
          alert('Please select at least one product.');
          return false;
        }
      }

      // Copy checked product IDs to OLX forms on submit
      bulkPublishForm.addEventListener('submit', function(e) {
        copyProductIdsToForm(bulkPublishForm, e);
      });

      bulkUpdateForm.addEventListener('submit', function(e) {
        copyProductIdsToForm(bulkUpdateForm, e);
      });

      bulkRemoveForm.addEventListener('submit', function(e) {
        copyProductIdsToForm(bulkRemoveForm, e);
      });
    });
  </script>
<% else %>
  <div class="text-center py-12 bg-white rounded-lg shadow">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
    </svg>
    <% if params[:olx_status].present? || params[:template_id].present? %>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No products match your filters</h3>
      <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or clear them to see all products.</p>
      <div class="mt-6">
        <%= link_to "Clear Filters", shop_products_path(@shop), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
      </div>
    <% else %>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No products</h3>
      <p class="mt-1 text-sm text-gray-500">Get started by adding a product or importing from CSV/Intercars.</p>
      <div class="mt-6 flex justify-center space-x-3">
        <%= link_to "New Product", new_shop_product_path(@shop), class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700" %>
        <%= link_to "Import Products", new_shop_import_path(@shop), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
      </div>
    <% end %>
  </div>
<% end %>
