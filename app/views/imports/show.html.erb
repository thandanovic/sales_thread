<%# Page Header %>
<%= render "shared/components/page_header",
    title: "Import Details",
    subtitle: "#{@import.source.humanize} Import - Created #{time_ago_in_words(@import.created_at)} ago",
    actions: capture {
      link_to shop_imports_path(@shop), class: "inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-strokedark dark:bg-boxdark dark:text-bodydark1 dark:hover:bg-strokedark transition-colors" do
        raw('<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>') +
        "Back to Imports"
      end
    } %>

<%# Status Card %>
<%= render "shared/components/card" do %>
  <div class="flex items-center justify-between mb-6">
    <div>
      <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Import Status</h3>
      <div class="flex items-center gap-3">
        <% case @import.status %>
        <% when 'completed' %>
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-success/10 border-2 border-success/30 font-semibold text-success">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Completed
          </div>
        <% when 'completed_with_errors' %>
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-warning/10 border-2 border-warning/30 font-semibold text-warning">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Completed with Errors
          </div>
        <% when 'processing' %>
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-info/10 border-2 border-info/30 font-semibold text-info">
            <svg class="h-5 w-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Processing
          </div>
        <% when 'failed' %>
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-danger/10 border-2 border-danger/30 font-semibold text-danger">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Failed
          </div>
        <% else %>
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-100 border-2 border-gray-200 font-semibold text-gray-700 dark:bg-strokedark dark:border-strokedark dark:text-bodydark1">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Pending
          </div>
        <% end %>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <% if @import.status == 'pending' %>
        <%= button_to "Start Processing", start_processing_shop_import_path(@shop, @import), method: :post, class: "inline-flex items-center gap-2 rounded-lg bg-success px-5 py-2.5 text-sm font-medium text-white hover:bg-success/90 transition-colors" %>
      <% end %>

      <% if @import.source == 'intercars' && %w[completed completed_with_errors failed].include?(@import.status) %>
        <%= button_to retry_import_shop_import_path(@shop, @import), method: :post, data: { turbo_confirm: "Are you sure you want to re-run this import? This will clear all previously imported products from this import and scrape again." }, class: "inline-flex items-center gap-2 rounded-lg bg-info px-5 py-2.5 text-sm font-medium text-white hover:bg-info/90 transition-colors" do %>
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Re-run Import
        <% end %>
      <% end %>
    </div>
  </div>

  <%# Progress Section (only show when processing) %>
  <% if @import.status == 'processing' %>
    <div class="mb-6" id="progress-section">
      <%# Current Phase Indicator %>
      <div class="flex items-center gap-4 mb-4">
        <div class="flex items-center gap-2">
          <div id="phase-scraping-indicator" class="h-3 w-3 rounded-full <%= @import.current_phase == 'scraping' ? 'bg-info animate-pulse' : (@import.current_phase == 'importing' || @import.current_phase == 'completed' ? 'bg-success' : 'bg-gray-300') %>"></div>
          <span id="phase-scraping-text" class="text-sm <%= @import.current_phase == 'scraping' ? 'font-semibold text-info' : 'text-gray-500 dark:text-bodydark2' %>">
            1. Scraping
            <span id="scraped-count" class="<%= @import.current_phase == 'scraping' ? '' : 'hidden' %>">(<%= @import.scraped_count || 0 %>/<%= @import.total_rows || 0 %>)</span>
          </span>
        </div>
        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <div class="flex items-center gap-2">
          <div id="phase-importing-indicator" class="h-3 w-3 rounded-full <%= @import.current_phase == 'importing' ? 'bg-info animate-pulse' : (@import.current_phase == 'completed' ? 'bg-success' : 'bg-gray-300') %>"></div>
          <span id="phase-importing-text" class="text-sm <%= @import.current_phase == 'importing' ? 'font-semibold text-info' : 'text-gray-500 dark:text-bodydark2' %>">
            2. Importing
            <span id="imported-count" class="<%= @import.current_phase == 'importing' ? '' : 'hidden' %>">(<%= @import.processed_rows || 0 %>/<%= @import.total_rows || 0 %>)</span>
          </span>
        </div>
      </div>

      <%# Progress Bar %>
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-gray-700 dark:text-bodydark1" id="progress-label">
          <%= case @import.current_phase
              when 'scraping' then 'Scraping products from Intercars...'
              when 'importing' then 'Importing products to database...'
              else 'Processing...'
              end %>
        </span>
        <span class="text-sm font-medium text-info" id="progress-text">
          <% if @import.current_phase == 'scraping' %>
            <span id="current-count"><%= @import.scraped_count || 0 %></span> / <span id="total-count"><%= @import.total_rows || 0 %></span> scraped
          <% else %>
            <span id="current-count"><%= @import.processed_rows || 0 %></span> / <span id="total-count"><%= @import.total_rows || 0 %></span> imported
          <% end %>
        </span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-strokedark overflow-hidden">
        <% current_progress = if @import.current_phase == 'scraping'
                                @import.scraped_count.to_i
                              else
                                @import.processed_rows.to_i
                              end
           percent = @import.total_rows.to_i > 0 ? ((current_progress.to_f / @import.total_rows.to_i) * 100).round(1) : 0
        %>
        <div id="progress-bar" class="bg-info h-4 rounded-full transition-all duration-500 flex items-center justify-center" style="width: <%= percent %>%">
          <span class="text-xs font-medium text-white" id="progress-percent"><%= percent.round(0) %>%</span>
        </div>
      </div>
      <p class="mt-2 text-xs text-gray-500 dark:text-bodydark2 text-center">
        <svg class="inline-block h-4 w-4 animate-spin mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Auto-refreshing every 3 seconds...
      </p>
    </div>
  <% end %>

  <%# Progress Stats %>
  <div class="grid grid-cols-1 gap-4 sm:grid-cols-4 mb-6" id="stats-grid">
    <div class="rounded-lg bg-gray-50 px-4 py-5 dark:bg-strokedark">
      <p class="text-sm font-medium text-gray-500 dark:text-bodydark2">Target Products</p>
      <p class="mt-1 text-3xl font-bold text-gray-900 dark:text-white" id="stat-total"><%= @import.total_rows || 0 %></p>
    </div>

    <div class="rounded-lg bg-success/10 px-4 py-5">
      <p class="text-sm font-medium text-success">Successful</p>
      <p class="mt-1 text-3xl font-bold text-success" id="stat-success"><%= @import.successful_rows || 0 %></p>
    </div>

    <div class="rounded-lg bg-danger/10 px-4 py-5">
      <p class="text-sm font-medium text-danger">Failed</p>
      <p class="mt-1 text-3xl font-bold text-danger" id="stat-failed"><%= @import.failed_rows || 0 %></p>
    </div>

    <div class="rounded-lg bg-info/10 px-4 py-5">
      <p class="text-sm font-medium text-info">Processed</p>
      <p class="mt-1 text-3xl font-bold text-info" id="stat-processed"><%= @import.processed_rows || 0 %></p>
    </div>
  </div>

  <%# Timestamps %>
  <div class="border-t border-gray-200 dark:border-strokedark pt-4">
    <dl class="grid grid-cols-1 gap-4 sm:grid-cols-3">
      <div>
        <dt class="text-sm font-medium text-gray-500 dark:text-bodydark2">Started At</dt>
        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
          <%= @import.started_at ? @import.started_at.strftime('%Y-%m-%d %H:%M:%S') : 'Not started' %>
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500 dark:text-bodydark2">Completed At</dt>
        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
          <%= @import.completed_at ? @import.completed_at.strftime('%Y-%m-%d %H:%M:%S') : 'Not completed' %>
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500 dark:text-bodydark2">Duration</dt>
        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
          <% if @import.started_at && @import.completed_at %>
            <%= distance_of_time_in_words(@import.started_at, @import.completed_at) %>
          <% elsif @import.started_at %>
            <%= distance_of_time_in_words(@import.started_at, Time.current) %> (ongoing)
          <% else %>
            N/A
          <% end %>
        </dd>
      </div>
    </dl>
  </div>
<% end %>

<%# Error Messages %>
<% if @import.error_messages.present? %>
  <div class="mt-6 rounded-lg bg-danger/10 border-l-4 border-danger p-6">
    <div class="flex gap-3">
      <svg class="h-6 w-6 text-danger flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div class="flex-1">
        <% errors = JSON.parse(@import.error_messages) rescue [@import.error_messages] %>
        <% error_count = errors.is_a?(Array) ? errors.length : 1 %>
        <h3 class="text-lg font-medium text-danger mb-3">Import Errors (<%= error_count %>)</h3>

        <div class="text-sm text-danger/80 space-y-2">
          <% if errors.is_a?(Array) %>
            <% if errors.length > 10 %>
              <ul class="list-disc list-inside space-y-1 mb-3">
                <% errors.first(10).each_with_index do |error, index| %>
                  <li><strong>#<%= index + 1 %>:</strong> <%= error %></li>
                <% end %>
              </ul>

              <details class="mt-4">
                <summary class="cursor-pointer text-danger font-medium hover:underline">
                  Show <%= errors.length - 10 %> more errors...
                </summary>
                <ul class="list-disc list-inside space-y-1 mt-3 ml-4">
                  <% errors[10..-1].each_with_index do |error, index| %>
                    <li><strong>#<%= index + 11 %>:</strong> <%= error %></li>
                  <% end %>
                </ul>
              </details>
            <% else %>
              <ul class="list-disc list-inside space-y-1">
                <% errors.each_with_index do |error, index| %>
                  <li><strong>#<%= index + 1 %>:</strong> <%= error %></li>
                <% end %>
              </ul>
            <% end %>
          <% else %>
            <div class="p-3 bg-danger/10 rounded-lg border border-danger/20">
              <p class="font-mono text-xs"><%= errors %></p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<%# Metadata %>
<% if @import.metadata.present? %>
  <div class="mt-6">
    <%= render "shared/components/card", title: "Import Configuration" do %>
      <% metadata = JSON.parse(@import.metadata) rescue {} %>
      <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <% metadata.each do |key, value| %>
          <% next if key == 'password' || key == 'save_credentials' %>
          <div class="border-b border-gray-200 dark:border-strokedark pb-2">
            <dt class="text-sm font-medium text-gray-500 dark:text-bodydark2"><%= key.humanize %></dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-white"><%= value %></dd>
          </div>
        <% end %>
      </dl>
    <% end %>
  </div>
<% end %>

<%# Imported Products %>
<div id="imported-products" class="mt-6">
  <%= render "shared/components/card", title: "Imported Products", padding: false do %>
    <% if @import.has_errors? %>
      <div class="px-6 py-3 bg-gray-50 dark:bg-strokedark border-b border-gray-200 dark:border-strokedark">
        <p class="text-sm text-gray-500 dark:text-bodydark2">
          Showing all products including <%= @import.failed_rows %> failed imports
        </p>
      </div>
    <% end %>

    <% if @imported_products.any? %>
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead>
            <tr class="bg-gray-50 text-left dark:bg-strokedark">
              <th class="px-6 py-4 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-bodydark2">Product</th>
              <th class="px-6 py-4 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-bodydark2">SKU</th>
              <th class="px-6 py-4 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-bodydark2">Status</th>
              <th class="px-6 py-4 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-bodydark2">Error</th>
              <th class="px-6 py-4 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-bodydark2">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-strokedark">
            <% @imported_products.each do |imported_product| %>
              <tr class="hover:bg-gray-50 dark:hover:bg-strokedark transition-colors">
                <td class="px-6 py-4">
                  <p class="text-sm font-medium text-gray-900 dark:text-white">
                    <%= imported_product.product&.title || JSON.parse(imported_product.raw_data)['title'] rescue 'N/A' %>
                  </p>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="text-sm font-mono text-gray-600 dark:text-bodydark2">
                    <%= imported_product.product&.sku || JSON.parse(imported_product.raw_data)['sku'] rescue 'N/A' %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% case imported_product.status %>
                  <% when 'imported' %>
                    <%= render "shared/components/badge", text: "Imported", type: "success" %>
                  <% when 'error' %>
                    <%= render "shared/components/badge", text: "Error", type: "danger" %>
                  <% when 'processing' %>
                    <%= render "shared/components/badge", text: "Processing", type: "info" %>
                  <% else %>
                    <%= render "shared/components/badge", text: imported_product.status, type: "default" %>
                  <% end %>
                </td>
                <td class="px-6 py-4 text-sm text-danger max-w-xs truncate">
                  <%= imported_product.error_text&.truncate(50) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% if imported_product.product %>
                    <%= link_to "View", shop_product_path(@shop, imported_product.product), class: "text-sm font-medium text-primary hover:text-primary-dark" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="px-6 py-4 border-t border-gray-200 dark:border-strokedark">
        <%= paginate @imported_products %>
      </div>
    <% else %>
      <div class="px-6 py-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        <p class="mt-4 text-sm text-gray-500 dark:text-bodydark2">No imported products yet</p>
      </div>
    <% end %>
  <% end %>
</div>

<% if @import.status == 'processing' %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const progressUrl = '<%= progress_shop_import_path(@shop, @import) %>';
  let refreshInterval;

  function updateProgress() {
    fetch(progressUrl, {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      // Update stats
      document.getElementById('stat-total').textContent = data.total_rows;
      document.getElementById('stat-success').textContent = data.successful_rows;
      document.getElementById('stat-failed').textContent = data.failed_rows;
      document.getElementById('stat-processed').textContent = data.processed_rows;

      // Update phase indicators
      const phaseScrapingIndicator = document.getElementById('phase-scraping-indicator');
      const phaseImportingIndicator = document.getElementById('phase-importing-indicator');
      const phaseScrapingText = document.getElementById('phase-scraping-text');
      const phaseImportingText = document.getElementById('phase-importing-text');
      const scrapedCount = document.getElementById('scraped-count');
      const importedCount = document.getElementById('imported-count');
      const progressLabel = document.getElementById('progress-label');
      const progressText = document.getElementById('progress-text');

      if (data.current_phase === 'scraping') {
        // Scraping phase
        phaseScrapingIndicator.className = 'h-3 w-3 rounded-full bg-info animate-pulse';
        phaseImportingIndicator.className = 'h-3 w-3 rounded-full bg-gray-300';
        phaseScrapingText.className = 'text-sm font-semibold text-info';
        phaseImportingText.className = 'text-sm text-gray-500 dark:text-bodydark2';
        scrapedCount.classList.remove('hidden');
        scrapedCount.textContent = '(' + data.scraped_count + '/' + data.total_rows + ')';
        importedCount.classList.add('hidden');
        progressLabel.textContent = 'Scraping products from Intercars...';
        progressText.innerHTML = '<span id="current-count">' + data.scraped_count + '</span> / <span id="total-count">' + data.total_rows + '</span> scraped';
      } else if (data.current_phase === 'importing') {
        // Importing phase
        phaseScrapingIndicator.className = 'h-3 w-3 rounded-full bg-success';
        phaseImportingIndicator.className = 'h-3 w-3 rounded-full bg-info animate-pulse';
        phaseScrapingText.className = 'text-sm text-gray-500 dark:text-bodydark2';
        phaseImportingText.className = 'text-sm font-semibold text-info';
        scrapedCount.classList.add('hidden');
        importedCount.classList.remove('hidden');
        importedCount.textContent = '(' + data.processed_rows + '/' + data.total_rows + ')';
        progressLabel.textContent = 'Importing products to database...';
        progressText.innerHTML = '<span id="current-count">' + data.processed_rows + '</span> / <span id="total-count">' + data.total_rows + '</span> imported';
      }

      // Update progress bar based on current phase
      const progressBar = document.getElementById('progress-bar');
      const progressPercent = document.getElementById('progress-percent');

      if (progressBar && data.total_rows > 0) {
        let currentProgress;
        if (data.current_phase === 'scraping') {
          currentProgress = data.scraped_count;
        } else {
          currentProgress = data.processed_rows;
        }
        const percent = Math.round((currentProgress / data.total_rows) * 100);
        progressBar.style.width = percent + '%';
        progressPercent.textContent = percent + '%';
      }

      // Check if completed - reload page to show final state
      if (data.status !== 'processing') {
        clearInterval(refreshInterval);
        window.location.reload();
      }
    })
    .catch(error => {
      console.error('Error fetching progress:', error);
    });
  }

  // Start polling every 3 seconds
  refreshInterval = setInterval(updateProgress, 3000);

  // Initial update
  updateProgress();
});
</script>
<% end %>
