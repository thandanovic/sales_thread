<%# Page Header %>
<%= render "shared/components/page_header",
    title: "New Import",
    subtitle: "Import products from CSV files or scrape from Intercars catalog" %>

<div class="max-w-4xl">
  <%# Tab Navigation %>
  <div class="mb-6 border-b border-gray-200 dark:border-strokedark">
    <nav class="-mb-px flex gap-6" aria-label="Tabs">
      <button onclick="switchTab('csv')" id="csv-tab" class="tab-button border-b-2 border-primary text-primary py-4 px-1 text-sm font-medium transition-colors">
        <span class="inline-flex items-center gap-2">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          CSV Upload
        </span>
      </button>
      <button onclick="switchTab('scraper')" id="scraper-tab" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-bodydark2 dark:hover:text-white py-4 px-1 text-sm font-medium transition-colors">
        <span class="inline-flex items-center gap-2">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
          </svg>
          Web Scraper (Intercars)
        </span>
      </button>
    </nav>
  </div>

  <%# CSV Upload Form %>
  <div id="csv-form" class="tab-content">
    <%= render "shared/components/card" do %>
      <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Upload CSV File</h3>
        <p class="text-sm text-gray-500 dark:text-bodydark2">Upload a CSV file with product data. We'll automatically detect and map columns.</p>
      </div>

      <%= form_with url: shop_imports_path(@shop), method: :post, multipart: true, class: "space-y-6" do |f| %>
        <%= f.hidden_field :source, value: 'csv' %>

        <div>
          <label class="mb-2.5 block text-sm font-medium text-gray-700 dark:text-bodydark1">
            OLX Category Template (Optional)
          </label>
          <%= select_tag :olx_category_template_id,
              options_from_collection_for_select(@shop.olx_category_templates, :id, :display_name),
              {
                prompt: "Select a template to auto-configure OLX settings",
                data: { controller: "slim-select", slim_select_placeholder_value: "Select a template...", slim_select_search_placeholder_value: "Search templates..." }
              } %>
          <p class="mt-1 text-xs text-gray-500 dark:text-bodydark2">If selected, imported products will be automatically assigned this template for OLX publishing</p>
        </div>

        <div>
          <label class="mb-2.5 block text-sm font-medium text-gray-700 dark:text-bodydark1">
            CSV File
          </label>
          <div class="relative rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-6 py-10 hover:border-primary hover:bg-primary/5 transition-colors dark:border-strokedark dark:bg-boxdark dark:hover:border-primary">
            <div class="text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div class="mt-4 flex justify-center text-sm text-gray-600 dark:text-bodydark2">
                <label class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none">
                  <span>Upload a file</span>
                  <%= f.file_field :csv_file, class: "sr-only", accept: ".csv", required: true %>
                </label>
                <p class="pl-1">or drag and drop</p>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-bodydark2">CSV files only</p>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-strokedark">
          <%= link_to "Cancel", shop_imports_path(@shop), class: "inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-strokedark dark:bg-boxdark dark:text-bodydark1 dark:hover:bg-strokedark transition-colors" %>
          <%= f.submit "Upload & Preview", class: "inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-white hover:bg-primary-dark transition-colors cursor-pointer" %>
        </div>
      <% end %>
    <% end %>
  </div>

  <%# Web Scraper Form %>
  <div id="scraper-form" class="tab-content hidden">
    <%= render "shared/components/card" do %>
      <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Scrape from Intercars</h3>
        <p class="text-sm text-gray-500 dark:text-bodydark2">Enter credentials and the product page URL to scrape products automatically.</p>
      </div>

      <%= form_with model: @import, url: shop_imports_path(@shop), method: :post, class: "space-y-6" do |f| %>
        <%= f.hidden_field :source, value: 'intercars' %>

        <div>
          <label class="mb-2.5 block text-sm font-medium text-gray-700 dark:text-bodydark1">
            OLX Category Template (Optional)
          </label>
          <%= select_tag :olx_category_template_id,
              options_from_collection_for_select(@shop.olx_category_templates, :id, :display_name),
              {
                prompt: "Select a template to auto-configure OLX settings",
                data: { controller: "slim-select", slim_select_placeholder_value: "Select a template...", slim_select_search_placeholder_value: "Search templates..." }
              } %>
          <p class="mt-1 text-xs text-gray-500 dark:text-bodydark2">If selected, imported products will be automatically assigned this template for OLX publishing</p>
        </div>

        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div>
            <label class="mb-2.5 block text-sm font-medium text-gray-700 dark:text-bodydark1">
              Intercars Username/Email
            </label>
            <%= text_field_tag :username, nil, class: "w-full rounded-lg border border-gray-300 bg-white py-3 px-4 text-gray-900 outline-none focus:border-primary focus:ring-1 focus:ring-primary dark:border-strokedark dark:bg-boxdark dark:text-white dark:focus:border-primary transition-colors", placeholder: "your-email@example.com", required: true %>
          </div>

          <div>
            <label class="mb-2.5 block text-sm font-medium text-gray-700 dark:text-bodydark1">
              Password
            </label>
            <%= password_field_tag :password, nil, class: "w-full rounded-lg border border-gray-300 bg-white py-3 px-4 text-gray-900 outline-none focus:border-primary focus:ring-1 focus:ring-primary dark:border-strokedark dark:bg-boxdark dark:text-white dark:focus:border-primary transition-colors", placeholder: "••••••••", required: true %>
          </div>
        </div>

        <div>
          <label class="mb-2.5 block text-sm font-medium text-gray-700 dark:text-bodydark1">
            Product Page URL
          </label>
          <%= text_field_tag :product_url, 'https://ba.e-cat.intercars.eu/bs/', class: "w-full rounded-lg border border-gray-300 bg-white py-3 px-4 text-gray-900 outline-none focus:border-primary focus:ring-1 focus:ring-primary dark:border-strokedark dark:bg-boxdark dark:text-white dark:focus:border-primary transition-colors", placeholder: "https://ba.e-cat.intercars.eu/bs/products", required: true %>
          <p class="mt-1 text-xs text-gray-500 dark:text-bodydark2">The URL of the page containing products to scrape</p>
        </div>

        <div>
          <label class="mb-2.5 block text-sm font-medium text-gray-700 dark:text-bodydark1">
            Maximum Products to Scrape
          </label>
          <%= number_field_tag :max_products, 50, min: 1, max: 500, class: "w-full rounded-lg border border-gray-300 bg-white py-3 px-4 text-gray-900 outline-none focus:border-primary focus:ring-1 focus:ring-primary dark:border-strokedark dark:bg-boxdark dark:text-white dark:focus:border-primary transition-colors" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-bodydark2">Limit: 1-500 products (to prevent overloading)</p>
        </div>

        <div class="flex items-center gap-2">
          <%= check_box_tag :save_credentials, '1', false, class: "h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary dark:border-strokedark dark:bg-boxdark" %>
          <label class="text-sm text-gray-700 dark:text-bodydark1">
            Save credentials for future imports (encrypted)
          </label>
        </div>

        <div class="rounded-lg bg-gray-50 dark:bg-strokedark p-4">
          <label class="mb-3 block text-sm font-medium text-gray-700 dark:text-bodydark1">
            Run Mode
          </label>
          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <label class="relative flex cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus:outline-none dark:border-strokedark dark:bg-boxdark hover:border-primary transition-colors">
              <%= radio_button_tag :run_mode, 'background', true, class: "sr-only peer" %>
              <span class="flex flex-1">
                <span class="flex flex-col">
                  <span class="block text-sm font-medium text-gray-900 dark:text-white">Background Job</span>
                  <span class="mt-1 flex items-center text-xs text-gray-500 dark:text-bodydark2">Runs in background, page auto-refreshes</span>
                </span>
              </span>
              <svg class="h-5 w-5 text-primary hidden peer-checked:block" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
              </svg>
              <span class="pointer-events-none absolute -inset-px rounded-lg border-2 border-transparent peer-checked:border-primary"></span>
            </label>

            <label class="relative flex cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus:outline-none dark:border-strokedark dark:bg-boxdark hover:border-primary transition-colors">
              <%= radio_button_tag :run_mode, 'direct', false, class: "sr-only peer" %>
              <span class="flex flex-1">
                <span class="flex flex-col">
                  <span class="block text-sm font-medium text-gray-900 dark:text-white">Direct (Wait)</span>
                  <span class="mt-1 flex items-center text-xs text-gray-500 dark:text-bodydark2">Runs immediately, waits for completion</span>
                </span>
              </span>
              <svg class="h-5 w-5 text-primary hidden peer-checked:block" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
              </svg>
              <span class="pointer-events-none absolute -inset-px rounded-lg border-2 border-transparent peer-checked:border-primary"></span>
            </label>
          </div>
          <p class="mt-2 text-xs text-gray-500 dark:text-bodydark2">
            <strong>Background:</strong> You can close the page and come back later.
            <strong>Direct:</strong> Page will wait until scraping completes (may timeout for large imports).
          </p>
        </div>

        <div class="rounded-lg bg-warning/10 border-l-4 border-warning p-4">
          <div class="flex gap-3">
            <svg class="h-5 w-5 text-warning flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <p class="text-sm text-warning">
              <strong>Note:</strong> Scraping may take a few minutes depending on the number of products. You'll be able to monitor progress on the import details page.
            </p>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-strokedark">
          <%= link_to "Cancel", shop_imports_path(@shop), class: "inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-strokedark dark:bg-boxdark dark:text-bodydark1 dark:hover:bg-strokedark transition-colors" %>
          <%= f.submit "Start Scraping", class: "inline-flex items-center gap-2 rounded-lg bg-success px-5 py-2.5 text-sm font-medium text-white hover:bg-success/90 transition-colors cursor-pointer" %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });

    // Remove active styling from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
      button.classList.remove('border-primary', 'text-primary');
      button.classList.add('border-transparent', 'text-gray-500');
    });

    // Show selected tab content
    document.getElementById(tabName + '-form').classList.remove('hidden');

    // Add active styling to selected tab
    const activeTab = document.getElementById(tabName + '-tab');
    activeTab.classList.add('border-primary', 'text-primary');
    activeTab.classList.remove('border-transparent', 'text-gray-500');
  }
</script>
