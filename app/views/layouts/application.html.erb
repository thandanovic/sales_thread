<!DOCTYPE html>
<html class="<%= cookies[:dark_mode] == 'true' ? 'dark' : '' %>">
  <head>
    <title><%= content_for(:title) || "SLX.ba" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/icon.png" type="image/png" sizes="180x180">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes Tailwind CSS %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <%# SlimSelect for searchable dropdowns %>
    <link href="https://cdn.jsdelivr.net/npm/slim-select@2.8.2/dist/slimselect.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/slim-select@2.8.2/dist/slimselect.min.js"></script>

    <%# SlimSelect custom styles (must load after CDN) %>
    <style>
      /* SlimSelect Custom Styles to match regular select (py-2.5 = 10px padding) */
      .ss-main {
        border: 1px solid #d1d5db !important;
        border-radius: 0.5rem !important;
        background-color: white !important;
        min-height: 42px !important;
        height: 42px !important;
        font-size: 0.875rem !important;
        padding: 0 !important;
      }

      .ss-main:focus,
      .ss-main.ss-open-below,
      .ss-main.ss-open-above {
        outline: none !important;
        border-color: #3C50E0 !important;
        box-shadow: 0 0 0 1px #3C50E0 !important;
      }

      .ss-main .ss-single-selected,
      .ss-main .ss-multi-selected {
        border: none !important;
        background-color: transparent !important;
        min-height: 40px !important;
        height: 40px !important;
        padding: 0 1rem !important;
        display: flex !important;
        align-items: center !important;
      }

      .ss-main .ss-values {
        display: flex !important;
        align-items: center !important;
        height: 100% !important;
      }

      .ss-main .ss-values .ss-single {
        margin: 0 !important;
        padding: 0 0.25rem !important;
        line-height: 1.25 !important;
      }

      .ss-main .ss-arrow {
        margin-right: 0.5rem !important;
      }

      .ss-main .ss-deselect {
        margin-right: 0.25rem !important;
      }

      .ss-content {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        margin-top: 4px;
      }

      .ss-content .ss-search {
        padding: 0.75rem;
      }

      .ss-content .ss-search input {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }

      .ss-content .ss-search input:focus {
        outline: none;
        border-color: #3C50E0;
        box-shadow: 0 0 0 1px #3C50E0;
      }

      .ss-content .ss-list .ss-option {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
      }

      .ss-content .ss-list .ss-option:hover {
        background-color: #f3f4f6;
      }

      .ss-content .ss-list .ss-option.ss-highlighted,
      .ss-content .ss-list .ss-option.ss-selected {
        background-color: #3C50E0;
        color: white;
      }

      /* SlimSelect Dark Mode */
      .dark .ss-main {
        background-color: #24303F !important;
        border-color: #2E3A47 !important;
        color: #DEE4EE !important;
      }

      .dark .ss-main .ss-single-selected .ss-placeholder {
        color: #8A99AF !important;
      }

      .dark .ss-main .ss-values .ss-single {
        color: #DEE4EE !important;
      }

      .dark .ss-content {
        background-color: #24303F;
        border-color: #2E3A47;
      }

      .dark .ss-content .ss-search input {
        background-color: #1A222C;
        border-color: #2E3A47;
        color: #DEE4EE;
      }

      .dark .ss-content .ss-search input::placeholder {
        color: #8A99AF;
      }

      .dark .ss-content .ss-list .ss-option {
        color: #DEE4EE;
      }

      .dark .ss-content .ss-list .ss-option:hover {
        background-color: #2E3A47;
      }

      .dark .ss-content .ss-list .ss-option.ss-highlighted,
      .dark .ss-content .ss-list .ss-option.ss-selected {
        background-color: #5B6CF4;
        color: white;
      }

      /* Hide original select when SlimSelect is active */
      select[data-controller="slim-select"] {
        display: none;
      }
    </style>

    <%= javascript_importmap_tags %>

    <%# Prevent flash of wrong theme %>
    <script>
      (function() {
        const theme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (theme === 'dark' || (!theme && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
  </head>

  <body class="font-sans antialiased bg-whiten text-gray-900 dark:bg-boxdark-2 dark:text-bodydark">
    <% if user_signed_in? %>
      <%# Impersonation Banner %>
      <%= render "shared/impersonation_banner" %>

      <%# Dashboard Layout with Sidebar %>
      <div class="flex h-screen overflow-hidden <%= 'pt-10' if impersonating? %>" data-controller="sidebar">
        <%# Sidebar %>
        <%= render "shared/layout/sidebar" %>

        <%# Main Content Area %>
        <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden lg:ml-72 page-transition">
          <%# Header %>
          <%= render "shared/layout/header" %>

          <%# Main Content %>
          <main class="mx-auto w-full max-w-screen-2xl p-4 md:p-6 2xl:p-10">
            <%# Flash Messages %>
            <% if notice.present? %>
              <%= render "shared/components/alert", type: "success", message: notice %>
            <% end %>
            <% if alert.present? %>
              <%= render "shared/components/alert", type: "error", message: alert %>
            <% end %>

            <%= yield %>
          </main>
        </div>
      </div>
    <% else %>
      <%# Auth Layout (minimal wrapper - pages handle their own layout) %>
      <%# Flash Messages %>
      <% if notice.present? %>
        <div class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4">
          <%= render "shared/components/alert", type: "success", message: notice %>
        </div>
      <% end %>
      <% if alert.present? %>
        <div class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4">
          <%= render "shared/components/alert", type: "error", message: alert %>
        </div>
      <% end %>

      <%= yield %>
    <% end %>
  </body>
</html>
